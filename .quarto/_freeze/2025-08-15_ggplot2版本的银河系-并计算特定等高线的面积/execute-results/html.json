{
  "hash": "1dea50f47c6ba118bf1cc9b68e1644df",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: ggplot2â€œé“¶æ²³ç³»â€ç­‰é«˜çº¿\nsubtitle: ggplot2ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼Œå¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯\ndate: 2025-08-15\ntoc-depth: 4\ntoc-expand: true\nlang: en\n---\nåœ¨2025-07-29æ—¥ï¼Œæˆ‘ä»¬å±•ç¤ºè¿‡H&Eèµ·æºç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼ˆ[QuPathï¼šâ€œé“¶æ²³ç³»â€èµ·æºäºH&E](2025-07-29_é“¶æ²³ç³»èµ·æºäºHE.qmd)ï¼‰ï¼Œåœ¨2025-08-12ï¼Œæˆ‘ä»¬é€šè¿‡Rçš„ggplot2æ¥å±•ç¤ºè¯¥â€œé“¶æ²³ç³»â€ï¼ˆ[Rï¼šggplot2ç­‰é«˜çº¿å›¾ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€](2025-08-12_ggplot2ç­‰é«˜çº¿å›¾ç‰ˆæœ¬çš„é“¶æ²³ç³».qmd)ï¼‰ã€‚\n\nè¿™æ¬¡ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯ã€‚\n\n## 1. Load packages and read data/åŠ è½½åŒ…å’Œè¯»å–æ•°æ®\n\nåŠ è½½åŒ…ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load packages\nlibrary(tidyverse) # for data manipulation and visualization\nlibrary(RColorBrewer) # for color palettes\nlibrary(patchwork) # for combining plots\nlibrary(pracma) # for calculating the area of a polygon\n```\n:::\n\n\nè¯»å–æ•°æ®ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read the table\ntxt_file <- \"raw_data/2025-08-12_QuPath_InstanSeg.txt\" # specify the path to the text file\ndf <- txt_file |> read_delim(delim = \"\\t\", col_names = TRUE, show_col_types = FALSE) # read the text file as a data frame\ntxt_file |> rm() # remove the txt_file variable to free up memory\n\ndf <- df |> \n    dplyr::select(`Centroid X Âµm`, `Centroid Y Âµm`) # select the columns specifying the coordinates of nuclei\ndf |> head() # display the first few rows of the data frame\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 Ã— 2\n  `Centroid X Âµm` `Centroid Y Âµm`\n            <dbl>           <dbl>\n1            131.            88.4\n2            118.            90.2\n3            169.            90.9\n4            179.            95.0\n5            230.            96.5\n6            119.            96.8\n```\n\n\n:::\n:::\n\n\n## 2. Plot the nuclei as points and add contour lines/ç»˜åˆ¶ç»†èƒæ ¸å’Œæ·»åŠ ç­‰é«˜çº¿\n\nPlot the nuclei as points./ç»˜åˆ¶ç»†èƒæ ¸ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnuclei <- ggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +\n  geom_point(color = \"#0072B2\") + # scatter plot\n  scale_x_continuous(limits = c(0, 1000)) + # set x limits\n  scale_y_continuous(limits = c(0, 900)) + # set y limits\n  theme_classic() # apply classic theme\n\nnuclei\n```\n\n::: {.cell-output-display}\n![](2025-08-15_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\nPlot the nuclei as points and add contour lines./ç»˜åˆ¶ç»†èƒæ ¸å’Œç­‰é«˜çº¿ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnuclei_contour_plot <- ggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +\n  geom_point(color = \"#0072B2\") + # scatter plot\n  geom_density_2d(aes(color = after_stat(level)), bins = 15) + # add contour lines\n  scale_color_viridis_c(option = \"H\") + # set color scale for contour lines\n  scale_x_continuous(limits = c(0, 1000)) + # set x limits\n  scale_y_continuous(limits = c(0, 900)) + # set y limits  \n  theme_classic() # apply classic theme\n\nnuclei_contour_plot\n```\n\n::: {.cell-output-display}\n![](2025-08-15_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n## 3. Claculate the area of a contour level/è®¡ç®—ä¸€ä¸ªç­‰é«˜çº¿çš„é¢ç§¯\n\nExtract the data used to create the contour plot/æå–ç”¨äºåˆ›å»ºç­‰é«˜çº¿å›¾çš„æ•°æ®\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- nuclei_contour_plot |> \n  ggplot_build() |> \n  pluck(\"data\", 2) # extract the data used to create the contour plot\n\nplot_data |> dim() # display the dimensions of the contour plot data\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 3915   12\n```\n\n\n:::\n\n```{.r .cell-code}\nplot_data |> distinct(level) # display distinct levels in the contour plot\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          level\n1  2.666667e-07\n2  5.333333e-07\n3  8.000000e-07\n4  1.066667e-06\n5  1.333333e-06\n6  1.600000e-06\n7  1.866667e-06\n8  2.133333e-06\n9  2.400000e-06\n10 2.666667e-06\n11 2.933333e-06\n12 3.200000e-06\n13 3.466667e-06\n14 3.733333e-06\n```\n\n\n:::\n:::\n\n\nSelect a level (e.g. 8th level)./é€‰æ‹©ä¸€ä¸ªç­‰é«˜çº¿ï¼ˆæ¯”å¦‚ç¬¬8ä¸ªlevelï¼‰\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlevels <- plot_data |> distinct(level) # select the unique levels\nplot_data_8 <- plot_data |> \n  filter(level == levels$level[8]) # filter the data for the 8th level\n```\n:::\n\n\nPlot the 8th contour level./ç»˜åˆ¶ç¬¬8ä¸ªç­‰é«˜çº¿\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontour_8 <- ggplot(plot_data_8, aes(x = x, y = y, group = group)) +\n  geom_polygon(color = \"blue\", fill = \"lightblue\", alpha = 0.5) + # draw the polygon with specified fill and border color\n  theme_classic() + # apply classic theme\n  scale_x_continuous(limits = c(0, 1000)) + # set x limits\n  scale_y_continuous(limits = c(0, 900)) # set y limits\n\ncontour_8\n```\n\n::: {.cell-output-display}\n![](2025-08-15_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\nCalculate the area and center of the 8th contour level using the `pracma` package/è®¡ç®—ç¬¬8ä¸ªç­‰é«˜çº¿çš„é¢ç§¯å’Œä¸­å¿ƒåæ ‡ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# set a function to calculate the area and center of a polygon\ncalculate_polygon_area_pracma <- function(df) {\n  x <- df$x\n  y <- df$y\n  n <- length(x)  \n  \n  area <- polyarea(x, y) # calculate the area\n  center <- poly_center(x, y) # calculate the center\n  return(c(area, center))\n}\n\n# use the function to calculate the area and center of each polygon of 8th contour level\narea_each_polygon <- plot_data_8 |> \n  group_by(group) |>\n  group_map(~ calculate_polygon_area_pracma(.x))\n\narea_each_polygon\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] 60220.5955   244.9297   538.7649\n\n[[2]]\n[1] 58107.1948   730.7534   362.4998\n\n[[3]]\n[1] 3757.6480  485.9918  299.8639\n```\n\n\n:::\n:::\n\n\nPlot the area of the 8th contour level with the area annotated./ç»˜åˆ¶é¢ç§¯å›¾ï¼Œå¹¶æ ‡æ³¨é¢ç§¯\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncontour_8_area <- ggplot(plot_data_8, aes(x = x, y = y, group = group)) +\n  geom_polygon(color = \"blue\", fill = \"lightblue\", alpha = 0.5) + # draw the polygon with specified fill and border color\n  theme_classic() + # apply classic theme\n  scale_x_continuous(limits = c(0, 1000)) + # set x limits\n  scale_y_continuous(limits = c(0, 900)) + # set y limits\n  annotate(\"text\", x = area_each_polygon[[1]][2], y = area_each_polygon[[1]][3], label = round(area_each_polygon[[1]][1], 2), size = 5, color = \"red\") + # add the area and center label\n  annotate(\"text\", x = area_each_polygon[[2]][2], y = area_each_polygon[[2]][3], label = round(area_each_polygon[[2]][1], 2), size = 5, color = \"red\") + # add the area and center label\n  annotate(\"text\", x = area_each_polygon[[3]][2], y = area_each_polygon[[3]][3], label = round(area_each_polygon[[3]][1], 2), size = 5, color = \"red\") # add the area and center label\n\ncontour_8_area\n```\n\n::: {.cell-output-display}\n![](2025-08-15_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\nPlot the 8th contour level with the arear annotated on the original image./ç»˜åˆ¶é¢ç§¯å›¾åˆ°åŸå›¾ï¼Œå¹¶æ ‡æ³¨é¢ç§¯\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +\n  geom_polygon(data = plot_data_8, aes(x = x, y = y, group = group), fill = \"#cccccc\") +\n  geom_point(color = \"#969696\") + # scatter plot\n  geom_density_2d(bins = 15, color = \"#cbc9e2\") + # add contour lines\n  scale_x_continuous(limits = c(0, 1000)) + # set x limits\n  scale_y_continuous(limits = c(0, 900)) + # set y limits  \n  theme_classic() + # apply classic theme  \n  annotate(\"text\", x = area_each_polygon[[1]][2], y = area_each_polygon[[1]][3], label = round(area_each_polygon[[1]][1], 2), size = 6, color = \"#f03b20\") + # add the area and center label\n  annotate(\"text\", x = area_each_polygon[[2]][2], y = area_each_polygon[[2]][3], label = round(area_each_polygon[[2]][1], 2), size = 6, color = \"#f03b20\") + # add the area and center label\n  annotate(\"text\", x = area_each_polygon[[3]][2], y = area_each_polygon[[3]][3], label = round(area_each_polygon[[3]][1], 2), size = 6, color = \"#f03b20\") # add the area and center label\n```\n\n::: {.cell-output-display}\n![](2025-08-15_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n## 4. â€œé“¶è¡Œç³»â€çš„èµ·æº\n\n<img src=\"images/he_low.png\" style=\"width: 100%; height: auto;\">\n\n[ç»™æˆ‘ä¹°æ¯èŒ¶ğŸµ](ç»™æˆ‘ä¹°æ¯èŒ¶.qmd)",
    "supporting": [
      "2025-08-15_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}