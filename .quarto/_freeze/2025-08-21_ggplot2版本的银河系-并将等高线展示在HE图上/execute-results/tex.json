{
  "hash": "70b5ec7f3cd42b339e27372f482e7b96",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: ggplot2â€œé“¶æ²³ç³»â€ç­‰é«˜çº¿&HE\nsubtitle: ggplot2ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼Œå¹¶å°†ç­‰é«˜çº¿å±•ç¤ºåœ¨H&Eå›¾ä¸Š\ndate: 2025-08-21\ntoc-depth: 4\ntoc-expand: true\nlang: en\n---\n\nåœ¨2025-07-29ï¼Œæˆ‘ä»¬å±•ç¤ºè¿‡H&Eèµ·æºç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼ˆ[QuPathï¼šâ€œé“¶æ²³ç³»â€èµ·æºäºH&E](2025-07-29_é“¶æ²³ç³»èµ·æºäºHE.qmd)ï¼‰ã€‚åœ¨2025-08-12ï¼Œæˆ‘ä»¬é€šè¿‡Rçš„ggplot2æ¥å±•ç¤ºè¯¥â€œé“¶æ²³ç³»â€ï¼ˆ[Rï¼šggplot2ç­‰é«˜çº¿å›¾ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€](2025-08-12_ggplot2ç­‰é«˜çº¿å›¾ç‰ˆæœ¬çš„é“¶æ²³ç³».qmd)ï¼‰ã€‚åœ¨2025-08-15ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯ï¼ˆ[Rï¼šggplot2ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼Œå¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯](2025-08-15_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯.qmd)ï¼‰ã€‚\n\nè¿™æ¬¡ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥å°†ç­‰é«˜çº¿å’Œç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯å±•ç¤ºåœ¨H&Eå›¾ä¸Šã€‚\n\n## 1. Load packages and read data/åŠ è½½åŒ…å’Œè¯»å–æ•°æ®\n\nåŠ è½½åŒ…ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# load packages\nlibrary(tidyverse) # for data manipulation and visualization\nlibrary(RColorBrewer) # for color palettes\nlibrary(patchwork) # for combining plots\nlibrary(pracma) # for calculating the area of a polygon\nlibrary(terra) # for raster manipulation\nlibrary(grid) # for working with grid graphics\n```\n:::\n\n\nè¯»å–æ•°æ®ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# read the table\ntxt_file <- \"raw_data/2025-08-12_QuPath_InstanSeg.txt\" # specify the path to the text file\ndf <- txt_file |> read_delim(delim = \"\\t\", col_names = TRUE, show_col_types = FALSE) # read the text file as a data frame\ntxt_file |> rm() # remove the txt_file variable to free up memory\n\ndf <- df |> \n    dplyr::select(`Centroid X Âµm`, `Centroid Y Âµm`) # select the columns specifying the coordinates of nuclei\ndf |> head() # display the first few rows of the data frame\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 x 2\n  `Centroid X Âµm` `Centroid Y Âµm`\n            <dbl>           <dbl>\n1            131.            88.4\n2            118.            90.2\n3            169.            90.9\n4            179.            95.0\n5            230.            96.5\n6            119.            96.8\n```\n\n\n:::\n:::\n\n\n## 2. Plot the nuclei as points and add contour lines/ç»˜åˆ¶ç»†èƒæ ¸å’Œæ·»åŠ ç­‰é«˜çº¿\n\nPlot the nuclei as points and add contour lines./ç»˜åˆ¶ç»†èƒæ ¸å’Œç­‰é«˜çº¿ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnuclei_contour_plot <- ggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +\n  geom_point(color = \"#0072B2\") + # scatter plot\n  geom_density_2d(aes(color = after_stat(level)), bins = 15) + # add contour lines\n  scale_color_viridis_c(option = \"H\") + # set color scale for contour lines\n  scale_x_continuous(limits = c(0, 1000)) + # set x limits\n  scale_y_continuous(limits = c(0, 900)) + # set y limits  \n  theme_classic() # apply classic theme\n\nnuclei_contour_plot\n```\n\n::: {.cell-output-display}\n![](2025-08-21_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶å°†ç­‰é«˜çº¿å±•ç¤ºåœ¨HEå›¾ä¸Š_files/figure-pdf/unnamed-chunk-3-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n## 3. Claculate the area of a contour level/è®¡ç®—ä¸€ä¸ªç­‰é«˜çº¿çš„é¢ç§¯\n\nExtract the data used to create the contour plot and display its distinct levels./æå–ç”¨äºåˆ›å»ºç­‰é«˜çº¿å›¾çš„æ•°æ®å¹¶æ˜¾ç¤ºå®ƒçš„ä¸åŒç­‰çº§ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_data <- nuclei_contour_plot |> \n  ggplot_build() |> \n  pluck(\"data\", 2) # extract the data used to create the contour plot\n\nplot_data |> dim() # display the dimensions of the contour plot data\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 3915   12\n```\n\n\n:::\n\n```{.r .cell-code}\nplot_data |> distinct(level) # display distinct levels in the contour plot\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          level\n1  2.666667e-07\n2  5.333333e-07\n3  8.000000e-07\n4  1.066667e-06\n5  1.333333e-06\n6  1.600000e-06\n7  1.866667e-06\n8  2.133333e-06\n9  2.400000e-06\n10 2.666667e-06\n11 2.933333e-06\n12 3.200000e-06\n13 3.466667e-06\n14 3.733333e-06\n```\n\n\n:::\n:::\n\n\nSelect a level (e.g. 9th level)./é€‰æ‹©ä¸€ä¸ªç­‰é«˜çº¿ï¼ˆæ¯”å¦‚ç¬¬9ä¸ªlevelï¼‰\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlevels <- plot_data |> distinct(level) # select the unique levels\nplot_data_9 <- plot_data |> \n  filter(level == levels$level[9]) # filter the data for the 8th level\n```\n:::\n\n\nPlot the 9th contour level./ç»˜åˆ¶ç¬¬9ä¸ªç­‰é«˜çº¿ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(plot_data_9, aes(x = x, y = y, group = group)) +\n  geom_polygon(color = \"blue\", fill = \"lightblue\", alpha = 0.5) + # draw the polygon with specified fill and border color\n  theme_classic() + # apply classic theme\n  scale_x_continuous(limits = c(0, 1000)) + # set x limits\n  scale_y_continuous(limits = c(0, 900)) # set y limits\n```\n\n::: {.cell-output-display}\n![](2025-08-21_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶å°†ç­‰é«˜çº¿å±•ç¤ºåœ¨HEå›¾ä¸Š_files/figure-pdf/unnamed-chunk-6-1.pdf){fig-pos='H'}\n:::\n:::\n\n\nCalculate the area and center of the 9th contour level using the `pracma` package./è®¡ç®—ç¬¬9ä¸ªç­‰é«˜çº¿çš„é¢ç§¯å’Œä¸­å¿ƒåæ ‡ã€‚\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# set a function to calculate the area of a polygon\ncalculate_polygon_area_pracma <- function(df) {\n  x <- df$x\n  y <- df$y\n  n <- length(x)  \n  \n  area <- polyarea(x, y)\n  center <- poly_center(x, y) \n  return(c(area, center))\n}\n\n# use the function to calculate the area and center position of each polygon of 9th contour level\narea_each_polygon <- plot_data_9 |> \n  group_by(group) |>\n  group_map(~ calculate_polygon_area_pracma(.x))\n\narea_each_polygon\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[[1]]\n[1] 47900.0729   239.5070   544.1073\n\n[[2]]\n[1] 17762.3143   730.3807   461.9802\n\n[[3]]\n[1] 17132.1260   742.2732   276.3749\n```\n\n\n:::\n:::\n\n\nPlot the area of the 9th contour level.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(plot_data_9, aes(x = x, y = y, group = group)) +\n  geom_polygon(color = \"blue\", fill = \"lightblue\", alpha = 0.5) + # draw the polygon with specified fill and border color\n  theme_classic() + # apply classic theme\n  scale_x_continuous(limits = c(0, 1000)) + # set x limits\n  scale_y_continuous(limits = c(0, 900)) + # set y limits\n  annotate(\"text\", x = area_each_polygon[[1]][2], y = area_each_polygon[[1]][3], label = round(area_each_polygon[[1]][1], 2), size = 5, color = \"red\") + # add the area and center label\n  annotate(\"text\", x = area_each_polygon[[2]][2], y = area_each_polygon[[2]][3], label = round(area_each_polygon[[2]][1], 2), size = 5, color = \"red\") + # add the area and center label\n  annotate(\"text\", x = area_each_polygon[[3]][2], y = area_each_polygon[[3]][3], label = round(area_each_polygon[[3]][1], 2), size = 5, color = \"red\") # add the area and center label\n```\n\n::: {.cell-output-display}\n![](2025-08-21_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶å°†ç­‰é«˜çº¿å±•ç¤ºåœ¨HEå›¾ä¸Š_files/figure-pdf/unnamed-chunk-8-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n## 4. Read the original H&E/è¯»å–åŸå§‹H&Eå›¾ç‰‡\n\n\n::: {.cell}\n\n```{.r .cell-code}\nimg_path <- \"images/he_normal.tif\"\nimg <- terra::rast(img_path) # read the TIFF image\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: [rast] unknown extent\n```\n\n\n:::\n\n```{.r .cell-code}\nimg_path |> rm() # remove the img_path variable to free up memory\n\nimg |> dim() # display the dimensions: height x width x channels\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1536 1792    3\n```\n\n\n:::\n\n```{.r .cell-code}\nimg <- as.array(img)/255 # normalize the image (the original tif is 8-bit, so we need to divide by 255 to get the values between 0 and 1)\n\nimg_grob <- grid::rasterGrob(img, interpolate = TRUE) # convert raster image to graphical object for ggplot\n```\n:::\n\n\n## 5. Plot contour levelã€and area of 9th contour level on the H&E image/åœ¨H&Eå›¾ä¸Šç»˜åˆ¶ç­‰é«˜çº¿å’Œ9thç­‰é«˜çº¿çš„é¢ç§¯\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +\n  annotation_custom(\n    img_grob, xmin = 0, xmax = 896, ymin = 0, ymax = 768\n  ) + # Since the pixel width was set to 0.5 um, so the size of the image changed to 896 um x 768 um.\n  geom_polygon(data = plot_data_9, aes(x = x, y = y, group = group), fill = \"lightblue\", alpha = 0.8) +\n  geom_point(color = \"#969696\") + # scatter plot\n  geom_density_2d(bins = 15, color = \"#cbc9e2\") + # add contour lines\n  scale_x_continuous(limits = c(0, 1000)) + # set x limits\n  scale_y_continuous(limits = c(0, 900)) + # set y limits  \n  theme_classic() + # apply classic theme\n  coord_fixed() +  # fix the aspect ratio\n  annotate(\"text\", x = area_each_polygon[[1]][2], y = area_each_polygon[[1]][3], label = round(area_each_polygon[[1]][1], 2), size = 6, color = \"#f03b20\") + # add the area and center label\n  annotate(\"text\", x = area_each_polygon[[2]][2], y = area_each_polygon[[2]][3], label = round(area_each_polygon[[2]][1], 2), size = 6, color = \"#f03b20\") + # add the area and center label\n  annotate(\"text\", x = area_each_polygon[[3]][2], y = area_each_polygon[[3]][3], label = round(area_each_polygon[[3]][1], 2), size = 6, color = \"#f03b20\") # add the area and center label\n```\n\n::: {.cell-output-display}\n![](2025-08-21_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶å°†ç­‰é«˜çº¿å±•ç¤ºåœ¨HEå›¾ä¸Š_files/figure-pdf/unnamed-chunk-10-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n## 6. â€œé“¶è¡Œç³»â€çš„èµ·æº\n\n<img src=\"images/he_low.png\" style=\"width: 100%; height: auto;\">\n\n[ç»™æˆ‘ä¹°æ¯èŒ¶ğŸµ](ç»™æˆ‘ä¹°æ¯èŒ¶.qmd)",
    "supporting": [
      "2025-08-21_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶å°†ç­‰é«˜çº¿å±•ç¤ºåœ¨HEå›¾ä¸Š_files\\figure-pdf"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}