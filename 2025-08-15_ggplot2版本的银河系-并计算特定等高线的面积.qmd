---
title: ggplot2â€œé“¶æ²³ç³»â€ç­‰é«˜çº¿
subtitle: ggplot2ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼Œå¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯
date: 2025-08-15
toc-depth: 4
toc-expand: true
lang: en
---
åœ¨2025-07-29æ—¥ï¼Œæˆ‘ä»¬å±•ç¤ºè¿‡H&Eèµ·æºç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼ˆ[QuPathï¼šâ€œé“¶æ²³ç³»â€èµ·æºäºH&E](2025-07-29_é“¶æ²³ç³»èµ·æºäºHE.qmd)ï¼‰ï¼Œåœ¨2025-08-12ï¼Œæˆ‘ä»¬é€šè¿‡Rçš„ggplot2æ¥å±•ç¤ºè¯¥â€œé“¶æ²³ç³»â€ï¼ˆ[Rï¼šggplot2ç­‰é«˜çº¿å›¾ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€](2025-08-12_ggplot2ç­‰é«˜çº¿å›¾ç‰ˆæœ¬çš„é“¶æ²³ç³».qmd)ï¼‰ã€‚

è¿™æ¬¡ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯ã€‚

## 1. Load packages and read data/åŠ è½½åŒ…å’Œè¯»å–æ•°æ®

åŠ è½½åŒ…ã€‚

```{r}
#| message: false
#| warning: false
# load packages
library(tidyverse) # for data manipulation and visualization
library(RColorBrewer) # for color palettes
library(patchwork) # for combining plots
library(pracma) # for calculating the area of a polygon
```

è¯»å–æ•°æ®ã€‚

```{r}
# read the table
txt_file <- "raw_data/2025-08-12_QuPath_InstanSeg.txt" # specify the path to the text file
df <- txt_file |> read_delim(delim = "\t", col_names = TRUE, show_col_types = FALSE) # read the text file as a data frame
txt_file |> rm() # remove the txt_file variable to free up memory

df <- df |> 
    dplyr::select(`Centroid X Âµm`, `Centroid Y Âµm`) # select the columns specifying the coordinates of nuclei
df |> head() # display the first few rows of the data frame
```

## 2. Plot the nuclei as points and add contour lines/ç»˜åˆ¶ç»†èƒæ ¸å’Œæ·»åŠ ç­‰é«˜çº¿

Plot the nuclei as points./ç»˜åˆ¶ç»†èƒæ ¸ã€‚

```{r}
nuclei <- ggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +
  geom_point(color = "#0072B2") + # scatter plot
  scale_x_continuous(limits = c(0, 1000)) + # set x limits
  scale_y_continuous(limits = c(0, 900)) + # set y limits
  theme_classic() # apply classic theme

nuclei
```

Plot the nuclei as points and add contour lines./ç»˜åˆ¶ç»†èƒæ ¸å’Œç­‰é«˜çº¿ã€‚

```{r}
nuclei_contour_plot <- ggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +
  geom_point(color = "#0072B2") + # scatter plot
  geom_density_2d(aes(color = after_stat(level)), bins = 15) + # add contour lines
  scale_color_viridis_c(option = "H") + # set color scale for contour lines
  scale_x_continuous(limits = c(0, 1000)) + # set x limits
  scale_y_continuous(limits = c(0, 900)) + # set y limits  
  theme_classic() # apply classic theme

nuclei_contour_plot
```

## 3. Claculate the area of a contour level/è®¡ç®—ä¸€ä¸ªç­‰é«˜çº¿çš„é¢ç§¯

Extract the data used to create the contour plot/æå–ç”¨äºåˆ›å»ºç­‰é«˜çº¿å›¾çš„æ•°æ®

```{r}
plot_data <- nuclei_contour_plot |> 
  ggplot_build() |> 
  pluck("data", 2) # extract the data used to create the contour plot

plot_data |> dim() # display the dimensions of the contour plot data
plot_data |> distinct(level) # display distinct levels in the contour plot
```

Select a level (e.g. 8th level)./é€‰æ‹©ä¸€ä¸ªç­‰é«˜çº¿ï¼ˆæ¯”å¦‚ç¬¬8ä¸ªlevelï¼‰

```{r}
levels <- plot_data |> distinct(level) # select the unique levels
plot_data_8 <- plot_data |> 
  filter(level == levels$level[8]) # filter the data for the 8th level
```

Plot the 8th contour level./ç»˜åˆ¶ç¬¬8ä¸ªç­‰é«˜çº¿

```{r}
contour_8 <- ggplot(plot_data_8, aes(x = x, y = y, group = group)) +
  geom_polygon(color = "blue", fill = "lightblue", alpha = 0.5) + # draw the polygon with specified fill and border color
  theme_classic() + # apply classic theme
  scale_x_continuous(limits = c(0, 1000)) + # set x limits
  scale_y_continuous(limits = c(0, 900)) # set y limits

contour_8
```

Calculate the area and center of the 8th contour level using the `pracma` package/è®¡ç®—ç¬¬8ä¸ªç­‰é«˜çº¿çš„é¢ç§¯å’Œä¸­å¿ƒåæ ‡ã€‚

```{r}
# set a function to calculate the area and center of a polygon
calculate_polygon_area_pracma <- function(df) {
  x <- df$x
  y <- df$y
  n <- length(x)  
  
  area <- polyarea(x, y) # calculate the area
  center <- poly_center(x, y) # calculate the center
  return(c(area, center))
}

# use the function to calculate the area and center of each polygon of 8th contour level
area_each_polygon <- plot_data_8 |> 
  group_by(group) |>
  group_map(~ calculate_polygon_area_pracma(.x))

area_each_polygon
```

Plot the area of the 8th contour level with the area annotated./ç»˜åˆ¶é¢ç§¯å›¾ï¼Œå¹¶æ ‡æ³¨é¢ç§¯

```{r} 

contour_8_area <- ggplot(plot_data_8, aes(x = x, y = y, group = group)) +
  geom_polygon(color = "blue", fill = "lightblue", alpha = 0.5) + # draw the polygon with specified fill and border color
  theme_classic() + # apply classic theme
  scale_x_continuous(limits = c(0, 1000)) + # set x limits
  scale_y_continuous(limits = c(0, 900)) + # set y limits
  annotate("text", x = area_each_polygon[[1]][2], y = area_each_polygon[[1]][3], label = round(area_each_polygon[[1]][1], 2), size = 5, color = "red") + # add the area and center label
  annotate("text", x = area_each_polygon[[2]][2], y = area_each_polygon[[2]][3], label = round(area_each_polygon[[2]][1], 2), size = 5, color = "red") + # add the area and center label
  annotate("text", x = area_each_polygon[[3]][2], y = area_each_polygon[[3]][3], label = round(area_each_polygon[[3]][1], 2), size = 5, color = "red") # add the area and center label

contour_8_area
```

Plot the 8th contour level with the arear annotated on the original image./ç»˜åˆ¶é¢ç§¯å›¾åˆ°åŸå›¾ï¼Œå¹¶æ ‡æ³¨é¢ç§¯

```{r}
ggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +
  geom_polygon(data = plot_data_8, aes(x = x, y = y, group = group), fill = "#cccccc") +
  geom_point(color = "#969696") + # scatter plot
  geom_density_2d(bins = 15, color = "#cbc9e2") + # add contour lines
  scale_x_continuous(limits = c(0, 1000)) + # set x limits
  scale_y_continuous(limits = c(0, 900)) + # set y limits  
  theme_classic() + # apply classic theme  
  annotate("text", x = area_each_polygon[[1]][2], y = area_each_polygon[[1]][3], label = round(area_each_polygon[[1]][1], 2), size = 6, color = "#f03b20") + # add the area and center label
  annotate("text", x = area_each_polygon[[2]][2], y = area_each_polygon[[2]][3], label = round(area_each_polygon[[2]][1], 2), size = 6, color = "#f03b20") + # add the area and center label
  annotate("text", x = area_each_polygon[[3]][2], y = area_each_polygon[[3]][3], label = round(area_each_polygon[[3]][1], 2), size = 6, color = "#f03b20") # add the area and center label
```

## 4. â€œé“¶è¡Œç³»â€çš„èµ·æº

<img src="images/he_low.png" style="width: 100%; height: auto;">

[ç»™æˆ‘ä¹°æ¯èŒ¶ğŸµ](ç»™æˆ‘ä¹°æ¯èŒ¶.qmd)