---
title: ggplot2â€œé“¶æ²³ç³»â€ç­‰é«˜çº¿&HE
subtitle: ggplot2ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼Œå¹¶å°†ç­‰é«˜çº¿å±•ç¤ºåœ¨H&Eå›¾ä¸Š
date: 2025-08-21
toc-depth: 4
toc-expand: true
lang: en
---

åœ¨2025-07-29ï¼Œæˆ‘ä»¬å±•ç¤ºè¿‡H&Eèµ·æºç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼ˆ[QuPathï¼šâ€œé“¶æ²³ç³»â€èµ·æºäºH&E](2025-07-29_é“¶æ²³ç³»èµ·æºäºHE.qmd)ï¼‰ã€‚åœ¨2025-08-12ï¼Œæˆ‘ä»¬é€šè¿‡Rçš„ggplot2æ¥å±•ç¤ºè¯¥â€œé“¶æ²³ç³»â€ï¼ˆ[Rï¼šggplot2ç­‰é«˜çº¿å›¾ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€](2025-08-12_ggplot2ç­‰é«˜çº¿å›¾ç‰ˆæœ¬çš„é“¶æ²³ç³».qmd)ï¼‰ã€‚åœ¨2025-08-15ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯ï¼ˆ[Rï¼šggplot2ç‰ˆæœ¬çš„â€œé“¶æ²³ç³»â€ï¼Œå¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯](2025-08-15_ggplot2ç‰ˆæœ¬çš„é“¶æ²³ç³»-å¹¶è®¡ç®—ç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯.qmd)ï¼‰ã€‚

è¿™æ¬¡ï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥å°†ç­‰é«˜çº¿å’Œç‰¹å®šç­‰é«˜çº¿çš„é¢ç§¯å±•ç¤ºåœ¨H&Eå›¾ä¸Šã€‚

## 1. Load packages and read data/åŠ è½½åŒ…å’Œè¯»å–æ•°æ®

åŠ è½½åŒ…ã€‚

```{r}
#| message: false
#| warning: false
# load packages
library(tidyverse) # for data manipulation and visualization
library(RColorBrewer) # for color palettes
library(patchwork) # for combining plots
library(pracma) # for calculating the area of a polygon
library(terra) # for raster manipulation
library(grid) # for working with grid graphics
```

è¯»å–æ•°æ®ã€‚

```{r}
# read the table
txt_file <- "raw_data/2025-08-12_QuPath_InstanSeg.txt" # specify the path to the text file
df <- txt_file |> read_delim(delim = "\t", col_names = TRUE, show_col_types = FALSE) # read the text file as a data frame
txt_file |> rm() # remove the txt_file variable to free up memory

df <- df |> 
    dplyr::select(`Centroid X Âµm`, `Centroid Y Âµm`) # select the columns specifying the coordinates of nuclei
df |> head() # display the first few rows of the data frame
```

## 2. Plot the nuclei as points and add contour lines/ç»˜åˆ¶ç»†èƒæ ¸å’Œæ·»åŠ ç­‰é«˜çº¿

Plot the nuclei as points and add contour lines./ç»˜åˆ¶ç»†èƒæ ¸å’Œç­‰é«˜çº¿ã€‚

```{r}
nuclei_contour_plot <- ggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +
  geom_point(color = "#0072B2") + # scatter plot
  geom_density_2d(aes(color = after_stat(level)), bins = 15) + # add contour lines
  scale_color_viridis_c(option = "H") + # set color scale for contour lines
  scale_x_continuous(limits = c(0, 1000)) + # set x limits
  scale_y_continuous(limits = c(0, 900)) + # set y limits  
  theme_classic() # apply classic theme

nuclei_contour_plot
```

## 3. Claculate the area of a contour level/è®¡ç®—ä¸€ä¸ªç­‰é«˜çº¿çš„é¢ç§¯

Extract the data used to create the contour plot and display its distinct levels./æå–ç”¨äºåˆ›å»ºç­‰é«˜çº¿å›¾çš„æ•°æ®å¹¶æ˜¾ç¤ºå®ƒçš„ä¸åŒç­‰çº§ã€‚

```{r}
plot_data <- nuclei_contour_plot |> 
  ggplot_build() |> 
  pluck("data", 2) # extract the data used to create the contour plot

plot_data |> dim() # display the dimensions of the contour plot data
plot_data |> distinct(level) # display distinct levels in the contour plot
```

Select a level (e.g. 9th level)./é€‰æ‹©ä¸€ä¸ªç­‰é«˜çº¿ï¼ˆæ¯”å¦‚ç¬¬9ä¸ªlevelï¼‰

```{r}
levels <- plot_data |> distinct(level) # select the unique levels
plot_data_9 <- plot_data |> 
  filter(level == levels$level[9]) # filter the data for the 8th level
```

Plot the 9th contour level./ç»˜åˆ¶ç¬¬9ä¸ªç­‰é«˜çº¿ã€‚

```{r}
ggplot(plot_data_9, aes(x = x, y = y, group = group)) +
  geom_polygon(color = "blue", fill = "lightblue", alpha = 0.5) + # draw the polygon with specified fill and border color
  theme_classic() + # apply classic theme
  scale_x_continuous(limits = c(0, 1000)) + # set x limits
  scale_y_continuous(limits = c(0, 900)) # set y limits
```

Calculate the area and center of the 9th contour level using the `pracma` package./è®¡ç®—ç¬¬9ä¸ªç­‰é«˜çº¿çš„é¢ç§¯å’Œä¸­å¿ƒåæ ‡ã€‚

```{r}
# set a function to calculate the area of a polygon
calculate_polygon_area_pracma <- function(df) {
  x <- df$x
  y <- df$y
  n <- length(x)  
  
  area <- polyarea(x, y)
  center <- poly_center(x, y) 
  return(c(area, center))
}

# use the function to calculate the area and center position of each polygon of 9th contour level
area_each_polygon <- plot_data_9 |> 
  group_by(group) |>
  group_map(~ calculate_polygon_area_pracma(.x))

area_each_polygon
```

Plot the area of the 9th contour level.

```{r} 

ggplot(plot_data_9, aes(x = x, y = y, group = group)) +
  geom_polygon(color = "blue", fill = "lightblue", alpha = 0.5) + # draw the polygon with specified fill and border color
  theme_classic() + # apply classic theme
  scale_x_continuous(limits = c(0, 1000)) + # set x limits
  scale_y_continuous(limits = c(0, 900)) + # set y limits
  annotate("text", x = area_each_polygon[[1]][2], y = area_each_polygon[[1]][3], label = round(area_each_polygon[[1]][1], 2), size = 5, color = "red") + # add the area and center label
  annotate("text", x = area_each_polygon[[2]][2], y = area_each_polygon[[2]][3], label = round(area_each_polygon[[2]][1], 2), size = 5, color = "red") + # add the area and center label
  annotate("text", x = area_each_polygon[[3]][2], y = area_each_polygon[[3]][3], label = round(area_each_polygon[[3]][1], 2), size = 5, color = "red") # add the area and center label
```

## 4. Read the original H&E/è¯»å–åŸå§‹H&Eå›¾ç‰‡

```{r}
img_path <- "images/he_normal.tif"
img <- terra::rast(img_path) # read the TIFF image
img_path |> rm() # remove the img_path variable to free up memory

img |> dim() # display the dimensions: height x width x channels

img <- as.array(img)/255 # normalize the image (the original tif is 8-bit, so we need to divide by 255 to get the values between 0 and 1)

img_grob <- grid::rasterGrob(img, interpolate = TRUE) # convert raster image to graphical object for ggplot
```

## 5. Plot contour levelã€and area of 9th contour level on the H&E image/åœ¨H&Eå›¾ä¸Šç»˜åˆ¶ç­‰é«˜çº¿å’Œ9thç­‰é«˜çº¿çš„é¢ç§¯

```{r}
ggplot(df, aes(x = `Centroid X Âµm`, y = `Centroid Y Âµm`)) +
  annotation_custom(
    img_grob, xmin = 0, xmax = 896, ymin = 0, ymax = 768
  ) + # Since the pixel width was set to 0.5 um, so the size of the image changed to 896 um x 768 um.
  geom_polygon(data = plot_data_9, aes(x = x, y = y, group = group), fill = "lightblue", alpha = 0.8) +
  geom_point(color = "#969696") + # scatter plot
  geom_density_2d(bins = 15, color = "#cbc9e2") + # add contour lines
  scale_x_continuous(limits = c(0, 1000)) + # set x limits
  scale_y_continuous(limits = c(0, 900)) + # set y limits  
  theme_classic() + # apply classic theme
  coord_fixed() +  # fix the aspect ratio
  annotate("text", x = area_each_polygon[[1]][2], y = area_each_polygon[[1]][3], label = round(area_each_polygon[[1]][1], 2), size = 6, color = "#f03b20") + # add the area and center label
  annotate("text", x = area_each_polygon[[2]][2], y = area_each_polygon[[2]][3], label = round(area_each_polygon[[2]][1], 2), size = 6, color = "#f03b20") + # add the area and center label
  annotate("text", x = area_each_polygon[[3]][2], y = area_each_polygon[[3]][3], label = round(area_each_polygon[[3]][1], 2), size = 6, color = "#f03b20") # add the area and center label
```

## 6. â€œé“¶è¡Œç³»â€çš„èµ·æº

<img src="images/he_low.png" style="width: 100%; height: auto;">

[ç»™æˆ‘ä¹°æ¯èŒ¶ğŸµ](ç»™æˆ‘ä¹°æ¯èŒ¶.qmd)